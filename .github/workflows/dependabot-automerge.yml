name: Dependabot auto-merge
on:
  pull_request:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull Request Number"
        required: true
        type: number

permissions:
  pull-requests: write
  contents: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.actor == 'dependabot[bot]') ||
      (github.event_name == 'workflow_dispatch')
    steps:
      - name: Get PR URL
        id: pr_url
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "PR_URL=https://github.com/${{ github.repository }}/pull/${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "PR_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Check PR status
        id: pr_status
        run: |
          PR_STATUS=$(gh pr view "$PR_URL" --json statusCheckRollup --jq '.statusCheckRollup[].state' | sort -u)
          if [ "$PR_STATUS" = "SUCCESS" ]; then
            echo "PR_CHECKS_PASSED=true" >> $GITHUB_OUTPUT
          else
            echo "PR_CHECKS_PASSED=false" >> $GITHUB_OUTPUT
          fi
        env:
          PR_URL: ${{ steps.pr_url.outputs.PR_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve PR
        if: steps.pr_status.outputs.PR_CHECKS_PASSED == 'true'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ steps.pr_url.outputs.PR_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: steps.pr_status.outputs.PR_CHECKS_PASSED == 'true'
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ steps.pr_url.outputs.PR_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
